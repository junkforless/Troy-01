<div id="container"></div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
window.addEventListener("DOMContentLoaded", () => {

  const FRIENDLY = { a:"Boiler", b:"Return", c:"Ambient", d:"Tank" };

  const MQTT_URL  = "wss://81367823bf3f495e897a93f0d0bff0ee.s1.eu.hivemq.cloud:8884/mqtt";
  const MQTT_USER = "troy-esp-read-only";
  const MQTT_PASS = "4wH8s121f2mV4wH8s";

  let lastSeen = {};
  let readings = {};

  const DEFAULT_DEVICE = "Troy-ESP-01";

  function createDeviceBox(dev){
    const c = document.getElementById("container");
    if(!document.getElementById(`wrap_${dev}`)){
      const wrap = document.createElement("div");
      wrap.id = `wrap_${dev}`;
      wrap.className = "device";
      wrap.innerHTML = `
        <div class="dev-header">${dev}</div>
        <div id="ts_${dev}" class="timestamp">Waiting for data...</div>
        <div id="warn_${dev}" class="warn">⚠ STALE DATA</div>
        <div id="sens_${dev}"></div>
      `;
      c.appendChild(wrap);
      lastSeen[dev] = 0;
      readings[dev] = {};
    }
  }

  function updateDisplay(){
    const now = Math.floor(Date.now()/1000);
    for(const dev in readings){
      const stale = (now - lastSeen[dev]) > 60;
      document.getElementById(`warn_${dev}`).style.display = stale ? "block" : "none";

      const cont = document.getElementById(`sens_${dev}`);
      cont.innerHTML = "";
      const res = readings[dev];
      for(const k in FRIENDLY){
        const val = res[k];
        const v = (val != null && !isNaN(val)) ? Number(val).toFixed(1) : "--";
        const color = stale ? "#aaa" : "#000";
        cont.innerHTML += `<div class="sensor">
            <span>${FRIENDLY[k]}</span>
            <span style="color:${color}">${v}°F</span>
        </div>`;
      }

      // Move timestamp under the header
      const tsDiv = document.getElementById(`ts_${dev}`);
      tsDiv.innerText = `Last update: ${res.ep ? new Date(res.ep*1000).toLocaleTimeString() : "--:--:--"}`;
    }
  }

  setInterval(updateDisplay, 1000);

  createDeviceBox(DEFAULT_DEVICE);

  const client = mqtt.connect(MQTT_URL, {
    username: MQTT_USER,
    password: MQTT_PASS,
    clean: true
  });

  client.on("connect", ()=>{
    console.log("MQTT Connected");
    client.subscribe("Troy/Boiler/#");
  });

  client.on("reconnect", ()=>{
    console.log("MQTT Reconnecting...");
  });

  client.on("error", (err)=>{
    console.error("MQTT Error:", err);
  });

  client.on("message",(topic,msg)=>{
    try{
      const data = JSON.parse(msg.toString());
      const devTopic = topic.split("/").pop();
      createDeviceBox(devTopic);

      readings[devTopic] = data;
      lastSeen[devTopic] = data.ep;
      updateDisplay();
    }catch(e){
      console.error("Bad JSON", e, msg.toString());
    }
  });

});
</script>
